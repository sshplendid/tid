# 시작하기 - Part 3: 서비스

## 전제조건

* Docker 1.13 이상 설치
* Docker Compose 준비하기. Mac/Windows 용 Docker에 이미 설치되어 있습니다. Linux의 경우 직접 설치해야 합니다. Windows 10에선 *Hyper-V* 없이 Docker Toolbox를 사용하세요.
* Part 1을 읽고 Part 2에서 컨테이너 생성 방법에 대해서 학습합니다.
* `waltz` 이미지를 생성해서 레지스트리에 발행하는 것까지 해봐야 합니다. 이 장에서 공유한 이미ㄹ지를 사용할 예정입니다.
* 그 이미지가 배포된 컨테이너로서 작동하는지 확인합니다. `docker run -p 4000:80 사용자명/저장소:태그` 명령을 실행하면, `http://localhost:4000/`으로 접속되는 것을 확인해야 합니다.

## 소개

3장에서 애플리케이션 규모를 조절하고 로드밸런싱을 활성화 할 것입니다. 이 일을 하기 위해, **서비스**라는 분산 애플리케이션의 계층에 대해 알아야 합니다.

* Stack
* Service (지금 여기에 있습니다)
* Container (2장에서 다뤘습니다)

## 서비스에 대해

분산 애플리케이션에서 애플리케이션의 다른 조각들을 "서비스"라고 부릅니다. 한 예로, 만약 영상 공유 사이트가 있다고 가정합시다. 이 사이트는 애플리케이션 데이터를 데이터베이스에 저장하는 서비스, 사용자가 업로드한 뭔가를 백그라운드에서 변환하는 서비스, 프론트엔드를 위한 서비스 등 여러 서비스들을 포함할 것 입니다.

서비스는 단지 "운영 환경의 컨테이너들"입니다. 오로지 하나의 이미지를 실행하지만, 이미지를 실행하는 방법 - 어떤 포트를 사용해야 하는지, 컨테이너의 레플리카를 수요를 충족하도록 얼마나 많이 구동해야 하는지 등 - 편성합니다. 서비스의 규모를 조절하는 것은 소프트웨어의 조각들을 실행하는 컨테이너 인스턴스의 수나 프로세스 상에서 서비스를 위한 자원을 더 할당해야 하는 것을 의미합니다.

운이 좋게도 Docker 플랫폼에서 서비스를 정의하고, 실행하고, 규모를 조절하는 것은 매우 쉽습니다. 단지 `docker-compose.yml` 파일을 작성하면 됩니다.

## 첫 `docker-compose.yml` 파일

`docker-compose.yml` 파일은 Docker container가 운영 환경에서 행동하는 방법을 정의한 YAML 파일입니다.

### `docker-compose.yml`

`docker-compose.yml`로 아래 내용을 저장하세요. 하지만 그 전에 Part 2에서 레지스트리에 생성한 이미지를 발행하고 이 yml 파일을 업데이트 한 이미지를 수정해야 합니다.

```yml
version: "3"
services:
  web:
    # replace username/repo:tag with your name and image details
    image: username/repo:tag
    deploy:
      replicas: 5
      resources:
        limits:
          cpus: "0.1"
          memory: 50M
      restart_policy:
        condition: on-failure
    ports:
      - "80:80"
    networks:
      - webnet
networks:
  webnet:
```

이 `docker-compose.yml` 파일은 도커가 아래와 같은 일을 하게합니다.

* 레지스트리로 부터 Part2에서 업로드한 이미지를 끌어오기
* `web`이라고 5개의 인스턴스를 구동하고 각각의 인스턴스가 최대 10%의 CPU와 50MB의 램을 사용할 수 있도록 제한하기
* 컨테이너 중 하나가 동작 실패하는 경우 즉시 재시작하기
* 호스트의 4000번 포트를 `web`의 80번 포트와 매핑하기
* `web`의 컨테이너들이 `webnet`이라 불리는 로드밸런스 네트워크를 통해  80번 포트를 공유하도록 관리하기 (내부적으로 컨테이너 그 자체가 `web`의 80번 포트로 발행함)
* webnet` 네트워크를 기본 설정(로드밸런싱으로 뒤덮은 네트워크)으로 정의하기

## 새로운 로드밸런스된 애플리케이션 실행하기


